context("Test writePackage and buildPackage")

test_that("writePackage and buildPackage work for nFunction", 
          {
            nCompiler:::nFunctionIDMaker(reset = TRUE)
            nCompiler:::nClassIDMaker(reset = TRUE)
            
            foo <- nFunction(
              name = "foo",
              fun = function(x = numericScalar()) {
                ans <- x+1
                return(ans)
                returnType(numericScalar())
              }
            )
            
            writePackage(foo,
                         dir = tempdir(),
                         package.name = "fooPackage",
                         clean = TRUE, 
                         control = list(export = TRUE))
            ans <- buildPackage("fooPackage",
                                dir = tempdir())
            
            expect_equal(fooPackage::foo(2), 3)
          })

test_that("writePackage and buildPackage work for nClass", 
          {
            nCompiler:::nFunctionIDMaker(reset = TRUE)
            nCompiler:::nClassIDMaker(reset = TRUE)
            
            nc1 <- nClass(
              classname = "nc1",
              Rpublic = list(
                p1 = function(x) x+1
              ),
              Cpublic = list(
                x = 'numericScalar',
                cp1 = nFunction(
                  fun = function(x = 'numericScalar') {
                    ans <- x+1
                    return(ans)
                    returnType(numericScalar())
                  }
                )
              )
            )
            writePackage(
                nc1,
                dir = tempdir(),
                package.name = "nc1Package",
                clean = TRUE,
                nClass_full_interface = FALSE
            )
            buildPackage("nc1Package",
                         dir = tempdir())
                         #, lib = "test_package_nc1Package_lib")
            expect_true(require("nc1Package")) #, lib.loc = "test_package_nc1Package_lib"))
            expect_true(is.function(nc1Package:::new_nc1))
            obj <- nc1Package:::new_nc1()
            expect_equal(method(obj, 'cp1')(2), 3)
          })

test_that("writePackage and buildPackage work for nClass with full interface",
{
  nCompiler:::nFunctionIDMaker(reset = TRUE)
  nCompiler:::nClassIDMaker(reset = TRUE)

  nc2 <- nClass(
    classname = "nc2",
    Rpublic = list(
      p1 = function(x) x+1
    ),
    Cpublic = list(
      x = 'numericScalar',
      cp1 = nFunction(
        fun = function(x = numericScalar()) {
          ans <- x+1
          return(ans)
          returnType(numericScalar())
        }
      )
    )
  )
  writePackage(
      nc2,
      dir = tempdir(),
      package.name = "nc2Package",
      clean = TRUE
  )
  expect_true(buildPackage("nc2Package",
                           dir = tempdir()))
                           #, lib = "test_package_nc2Package_lib"))
  expect_true(isCompiledNCgenerator(nc2Package::nc2))
  obj <- nc2Package::nc2$new()
  expect_true(inherits(obj, "nClass"))
  expect_equal(obj$cp1(2), 3)
})


test_that("Create package with multiple objects", 
          {
            nCompiler:::nFunctionIDMaker(reset = TRUE)
            nCompiler:::nClassIDMaker(reset = TRUE)
            
            foo1 <- nFunction(
              name = "foo1",
              fun = function(x = numericScalar()) {
                ans <- x+1
                return(ans)
                returnType(numericScalar())
              }
            )
            
            foo2 <- nClass(
              classname = "foo2",
              Cpublic = list(
                cp1 = nFunction(
                  fun = function(x = numericScalar()) {
                    ans <- x+1
                    return(ans)
                    returnType(numericScalar())
                  }
                )
              )
            )
            
            writePackage(foo1, foo2,
                         dir = tempdir(),
                         package.name = "fooPackageMultiples",
                         clean = TRUE,
                         control = list(export = TRUE))
            ans <- buildPackage("fooPackageMultiples",
                                dir = tempdir())
            
            expect_equal(fooPackageMultiples::foo1(1), 2)
            my_foo2 <- fooPackageMultiples::foo2$new()
            expect_equal(my_foo2$cp1(10), 11)
          })


test_that("Export flag works", 
          {
            nCompiler:::nFunctionIDMaker(reset = TRUE)
            nCompiler:::nClassIDMaker(reset = TRUE)
            
            foo <- nFunction(
              name = "foo",
              fun = function(x = numericScalar()) {
                ans <- x+1
                return(ans)
                returnType(numericScalar())
              }
            )
            foo2 <- nFunction(
              name = "foo2",
              fun = function(x = numericScalar()) {
                ans <- x+2
                return(ans)
                returnType(numericScalar())
              }
            )
            
            writePackage(foo, foo2,
                         dir = tempdir(),
                         package.name = "fooPackageNoExport",
                         clean = TRUE,
                         control = list(
                           foo = list(export = FALSE),
                           foo2 = list(export = TRUE)))
            ans <- buildPackage("fooPackageNoExport",
                                dir = tempdir())
            
            expect_error(fooPackageNoExport::foo(2))
            expect_equal(fooPackageNoExport:::foo(2), 3)
            expect_equal(fooPackageNoExport::foo2(2), 4)
          })
